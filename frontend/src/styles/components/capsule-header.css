/**
 * Capsule Header - Dynamic Island Style Morphing
 *
 * Three states:
 * - Default  : [● Ping] [spacer] [avatar+status]                    ~220px
 * - Minimal  : [●]      [spacer] [avatar+status]                    ~80px
 * - Expanded : [● Ping] [spacer] [avatar+status] ‹expanded-zone›   ~520px
 *
 * expanded-zone contains (in a single flex row, no individual max-width):
 *   [name] [aesthetic-toggle] [theme-toggle] [sign-out]
 *
 * Overflow fix:
 *   A SINGLE .capsule-header__expanded-zone wraps all expanded items.
 *   max-width: 0 → 400px collapses/reveals the whole zone at once.
 *   Individual items use opacity + translateX for stagger — NOT max-width.
 *   This avoids each item being independently clipped by its own max-width.
 *
 * Glassmorphism: var(--glass-background)       ← @shared/design-tokens/colors.css
 * Status colors: var(--status-*)               ← @shared/design-tokens/colors.css
 * Pulse timing:  var(--status-pulse-*)         ← @shared/design-tokens/effects.css
 * Durations:     var(--duration-fast/normal)   ← @shared/design-tokens/animations.css
 */

/* ══════════════════════════════════════════════════════
   1. Presence Status Badge
   ══════════════════════════════════════════════════════ */

.user-status-badge {
    position: absolute;
    bottom: -1px;
    right: -1px;
    width: 9px;
    height: 9px;
    border-radius: 50%;
    box-shadow: 0 0 0 1.5px var(--background);
    transition: background-color 300ms ease-out;
    pointer-events: none;
}

.user-status-badge--online  { background: var(--status-online);  }
.user-status-badge--away    { background: var(--status-away);    }
.user-status-badge--busy    { background: var(--status-busy);    }
.user-status-badge--offline { background: var(--status-offline); }

/* ══════════════════════════════════════════════════════
   2. Online Sound Wave (pulse rings)
   ══════════════════════════════════════════════════════ */

.user-status-wave {
    position: absolute;
    inset: 0;
    border-radius: 50%;
    pointer-events: none;
}

.user-status-wave__ring {
    position: absolute;
    inset: 0;
    border-radius: 50%;
    border: 1.5px solid var(--status-online);
    opacity: 0;
    animation: status-wave-ring var(--status-pulse-duration, 1800ms) ease-out infinite;
}

.user-status-wave__ring:nth-child(1) { animation-delay: 0ms;    }
.user-status-wave__ring:nth-child(2) { animation-delay: 540ms;  }
.user-status-wave__ring:nth-child(3) { animation-delay: 1080ms; }

@keyframes status-wave-ring {
    0%   { transform: scale(1);    opacity: var(--status-pulse-opacity-start, 0.55); }
    100% { transform: scale(var(--status-pulse-scale-end, 2.2));
           opacity: var(--status-pulse-opacity-end, 0); }
}

/* ══════════════════════════════════════════════════════
   3. Status Picker Popover
   ══════════════════════════════════════════════════════ */

.user-status-picker {
    position: absolute;
    top: calc(100% + 10px);
    left: 50%;
    transform: translateX(-50%);
    z-index: 60;

    background: var(--glass-background-hover);
    backdrop-filter: blur(var(--blur-lg)) saturate(var(--glass-saturation-md));
    -webkit-backdrop-filter: blur(var(--blur-lg)) saturate(var(--glass-saturation-md));

    border: 1px solid oklch(from var(--border) l c h / 0.5);
    border-radius: 14px;
    box-shadow:
        0 4px 24px oklch(0 0 0 / 0.22),
        0 1px 0 oklch(1 0 0 / 0.08) inset;

    padding: 6px;
    min-width: 200px;
    width: max-content;
    animation: picker-appear 180ms cubic-bezier(0.34, 1.56, 0.64, 1) both;
}

@keyframes picker-appear {
    from { opacity: 0; transform: translateX(-50%) scale(0.92) translateY(-4px); }
    to   { opacity: 1; transform: translateX(-50%) scale(1)    translateY(0);    }
}

.user-status-picker__item {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    padding: 8px 10px;
    border: none;
    border-radius: 9px;
    background: transparent;
    color: var(--foreground);
    cursor: pointer;
    transition: background var(--duration-fast) ease-out;
    text-align: left;
}

.user-status-picker__item:hover      { background: oklch(from var(--primary) l c h / 0.10); }
.user-status-picker__item--active    { background: oklch(from var(--primary) l c h / 0.14); }

.user-status-picker__dot {
    position: static;
    display: inline-block;
    width: 9px;
    height: 9px;
    border-radius: 50%;
    flex-shrink: 0;
}

.user-status-picker__text  { display: flex; flex-direction: column; gap: 1px; }

.user-status-picker__label {
    font-size: 0.8125rem;
    font-weight: 500;
    line-height: 1.2;
    color: var(--foreground);
}

.user-status-picker__desc {
    font-size: 0.6875rem;
    color: var(--muted-foreground);
    line-height: 1.2;
}

/* ══════════════════════════════════════════════════════
   4. Avatar interactive ring
   ══════════════════════════════════════════════════════ */

.user-status-avatar__wrapper--interactive {
    border-radius: 50%;
    transition: box-shadow var(--duration-fast) ease-out;
}

.user-status-avatar__wrapper--interactive:hover,
.user-status-avatar__wrapper--interactive:focus-visible {
    outline: none;
    box-shadow: 0 0 0 2px oklch(from var(--primary) l c h / 0.5);
}

/* ══════════════════════════════════════════════════════
   5. ThemeToggle label (hidden on small screens)
   ══════════════════════════════════════════════════════ */

.theme-toggle__label { display: inline; }

@media (max-width: 639px) {
    .theme-toggle__label { display: none; }
}

/* ══════════════════════════════════════════════════════
   6. Capsule Container
   ══════════════════════════════════════════════════════ */

@layer components {
    .capsule-header {
        border-radius: 9999px;
        overflow: hidden;

        /* Glassmorphism — shared token is defined for both light/dark */
        background: var(--glass-background);
        backdrop-filter: blur(var(--blur-lg)) saturate(var(--glass-saturation-md)) brightness(1.04);
        -webkit-backdrop-filter: blur(var(--blur-lg)) saturate(var(--glass-saturation-md)) brightness(1.04);

        border: 1px solid oklch(from var(--border) l c h / 0.6);
        box-shadow:
            0 1px 0 oklch(1 0 0 / 0.1) inset,
            0 4px 20px oklch(0 0 0 / 0.12),
            0 12px 40px oklch(0 0 0 / 0.08);

        max-width: var(--capsule-max-width, 220px);
        width: calc(100vw - 32px);
        height: 48px;

        /* Only max-width drives morphing — all others are style transitions */
        transition:
            max-width    350ms cubic-bezier(0.34, 1.56, 0.64, 1),
            background   200ms ease-out,
            box-shadow   250ms ease-out,
            border-color 200ms ease-out;

        user-select: none;
        touch-action: manipulation;
    }

    :root.dark .capsule-header {
        box-shadow:
            0 1px 0 oklch(1 0 0 / 0.07) inset,
            0 4px 20px oklch(0 0 0 / 0.28),
            0 12px 40px oklch(0 0 0 / 0.18);
    }

    /* Minimal (~80px): logo dot + avatar */
    .capsule-header--minimal  { --capsule-max-width: 80px; }

    /* Expanded (~520px): all items visible */
    .capsule-header--expanded {
        --capsule-max-width: 520px;
        border-color: oklch(from var(--primary) l c h / 0.28);
        box-shadow:
            0 1px 0 oklch(1 0 0 / 0.12) inset,
            0 6px 24px oklch(0 0 0 / 0.18),
            0 16px 48px oklch(0 0 0 / 0.12),
            0 0 0 1px oklch(from var(--primary) l c h / 0.08);
    }

    /* ── Inner flex row ── */
    .capsule-header__inner {
        display: flex;
        align-items: center;
        height: 100%;
        padding: 0 12px;
        gap: 8px;
        white-space: nowrap;
        overflow: hidden;
    }

    /* ── Logo ── */
    .capsule-header__logo {
        display: flex;
        align-items: center;
        gap: 7px;
        flex-shrink: 0;
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
    }

    .capsule-header__logo-dot {
        width: 8px;
        height: 8px;
        min-width: 8px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--glow-primary), var(--glow-secondary));
        transition: transform 200ms ease-out, box-shadow 200ms ease-out;
        flex-shrink: 0;
    }

    .capsule-header:hover .capsule-header__logo-dot {
        transform: scale(1.3);
        box-shadow: 0 0 8px oklch(from var(--glow-primary) l c h / 0.5);
    }

    /* Logo text collapses in minimal */
    .capsule-header__logo-text {
        font-size: 0.9375rem;
        font-weight: 700;
        background: linear-gradient(135deg, var(--glow-primary), var(--glow-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        flex-shrink: 0;
        max-width: 60px;
        overflow: hidden;
        opacity: 1;
        transition:
            max-width 300ms cubic-bezier(0.34, 1.56, 0.64, 1),
            opacity   200ms ease-out;
    }

    .capsule-header--minimal .capsule-header__logo-text {
        max-width: 0;
        opacity: 0;
        pointer-events: none;
    }

    /* ── Flex spacer ── */
    .capsule-header__spacer { flex: 1; min-width: 0; }

    /* ── Avatar (always visible) ── */
    .capsule-header__avatar {
        flex-shrink: 0;
        display: flex;
        align-items: center;
    }

    /* ══════════════════════════════════════════════════
       EXPANDED ZONE — single container for ALL expanded
       items. Uses ONE max-width clip, not per-item.
       Items inside use opacity + translateX for stagger.
       ══════════════════════════════════════════════════ */

    .capsule-header__expanded-zone {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-shrink: 0;

        /* Collapsed state */
        max-width: 0;
        overflow: hidden;
        /* Do NOT set opacity here — children handle their own opacity for stagger */
        pointer-events: none;
        transition: max-width 320ms cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .capsule-header--expanded .capsule-header__expanded-zone {
        /* 400px gives plenty of room for name + 2 controls + sign-out */
        max-width: 400px;
        pointer-events: auto;
    }

    /* ── Stagger: each direct child fades + slides in ── */
    .capsule-header__expanded-zone > * {
        opacity: 0;
        transform: translateX(6px);
        transition:
            opacity   180ms ease-out,
            transform 180ms ease-out;
        flex-shrink: 0;
    }

    .capsule-header--expanded .capsule-header__expanded-zone > * {
        opacity: 1;
        transform: translateX(0);
    }

    /* Stagger delays for each child */
    .capsule-header--expanded .capsule-header__expanded-zone > *:nth-child(1) { transition-delay: 40ms;  }
    .capsule-header--expanded .capsule-header__expanded-zone > *:nth-child(2) { transition-delay: 80ms;  }
    .capsule-header--expanded .capsule-header__expanded-zone > *:nth-child(3) { transition-delay: 110ms; }
    .capsule-header--expanded .capsule-header__expanded-zone > *:nth-child(4) { transition-delay: 140ms; }

    /* ── User name inside expanded zone ── */
    .capsule-header__user-name {
        font-size: 0.8125rem;
        font-weight: 500;
        color: var(--muted-foreground);
        max-width: 90px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        padding: 0 2px;
    }

    /* ── Divider between name and controls ── */
    .capsule-header__divider {
        width: 1px;
        height: 16px;
        background: oklch(from var(--border) l c h / 0.5);
        flex-shrink: 0;
    }

    /* ── Controls row (no extra wrapper needed) ── */
    .capsule-header__controls {
        display: flex;
        align-items: center;
        gap: 4px;
        flex-shrink: 0;
    }

    /* ── Strip glass-button backgrounds inside the capsule controls ── */
    .capsule-header__controls .glass-button,
    .capsule-header__controls .glass-button:hover {
        background: transparent;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        box-shadow: none;
        border: none;
    }

    .capsule-header__controls .glass-button:hover {
        color: var(--foreground);
        opacity: 0.75;
        transform: none;
    }

    .capsule-header__controls .glass-button:hover::after {
        animation: none;
    }

    /* ── Nudge animation ── */
    @keyframes capsule-nudge {
        0%   { transform: translateX(-50%) scaleY(1)    scaleX(1);    }
        30%  { transform: translateX(-50%) scaleY(1.07) scaleX(0.97); }
        65%  { transform: translateX(-50%) scaleY(0.97) scaleX(1.02); }
        100% { transform: translateX(-50%) scaleY(1)    scaleX(1);    }
    }

    .capsule-header--nudge {
        animation: capsule-nudge 480ms cubic-bezier(0.34, 1.56, 0.64, 1);
    }
}

/* ══════════════════════════════════════════════════════
   7. Reduced Motion
   ══════════════════════════════════════════════════════ */

@media (prefers-reduced-motion: reduce) {
    .capsule-header,
    .capsule-header__logo-dot,
    .capsule-header__logo-text,
    .capsule-header__expanded-zone,
    .capsule-header__expanded-zone > *,
    .user-status-badge,
    .user-status-wave__ring,
    .user-status-picker {
        transition: none !important;
        animation: none !important;
    }

    .capsule-header--minimal .capsule-header__logo-text { display: none; }

    .capsule-header--expanded .capsule-header__expanded-zone {
        max-width: 400px;
    }

    .capsule-header--expanded .capsule-header__expanded-zone > * {
        opacity: 1;
        transform: none;
    }
}

/* ══════════════════════════════════════════════════════
   8. Safari: no backdrop-filter
   ══════════════════════════════════════════════════════ */

@supports not (backdrop-filter: blur(20px)) {
    .capsule-header        { background: oklch(from var(--card) l c h / 0.97); border-color: var(--border); }
    .user-status-picker    { background: var(--card); border-color: var(--border); }
}
